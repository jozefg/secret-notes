\documentclass{amsart}
\usepackage{preamble,categories,macros,}
\usepackage{locallabel,pftools}
\usepackage{jmsdelim}
\usepackage{jon-tikz}

\addbibresource{refs.bib}

\title{The Structure Sheaf of an Affine Scheme}
\author{Daniel Gratzer}
\date{\today}

\NewDocumentCommand{\Localize}{mm}{#1\brackets{#2^{-1}}}
\DeclareMathOperator{\Spec}{Spec}
\NewDocumentCommand{\StructSh}{}{\mathcal{O}}
\NewDocumentCommand{\Res}{mO{}m}{\mathbf{r}^{#2}_{#3}\parens{#1}}

\begin{document}
\begin{abstract}
  In this note, we present an elementary and short proof that the structure sheaf of an affine
  scheme is a sheaf for the Zariski topology.
\end{abstract}
\maketitle

Most of these proofs are heavily influenced by \citeauthor{vakil:rising-sea}'s
proofs~\parencite{vakil:rising-sea}.

Throughout this note, let us fix a ring $A$. We will not assume that $A$ is an integral domain or
reduced or similar. Accordingly, the construction of a localization of $A$ for some multiplicatively
closed subset $S$ is slightly more involved. As one might expect, elements of $\Localize{A}{S}$ are
fractions $a/s$ where $a \in A$ and $s \in S$ with addition and multiplication following the
standard rules for fractions. However, we further quotient this set by the following relation:
\begin{equation}
  a/s = b/t \iff \exists u \in S.\ u(at - bs) = 0
  \label{eq:frac-rel}
\end{equation}
If $A$ is an integral domain, then this is precisely the diagonal.

Let us recall $\Spec(A)$ is the space of prime ideals of $A$ with the topology generated by the
following basic opens $D(f)$:
\[
  D(f) = \braces{p \mid f \not\in p}
\]
These are the compliments of the more familiar $V(I) = \{p \mid I \subseteq p\}$, where we have
restricted $I$ to be a single element. It follows from a standard algebraic argument that
$D(f) \cap D(g) = D(fg)$, so this set is closed under finite intersections. We also note that
$D(f^n) = D(f)$, which follows fact that we consider only prime ideals. We define the structure
sheaf $\StructSh$ on $\Spec(A)$ by defining it on the basic open sets and extending it to arbitrary
opens through the standard procedure. We therefore must define $\StructSh$ on $D(f)$ as follows:
\[
  \StructSh(D(f)) = A_f
\]
We observe that if $D(f) \subseteq D(g)$ then we must have $V(g) \subseteq V(f)$, so $g \in p$
implies $f \in p$ for any prime ideal $p$. As a consequence, in $g$ must not be contained in any
prime ideals in $A_f$ as the prime ideals of $A_f$ are precisely primes of $A$ which avoid
$f$. Therefore, $g$ is invertible in $A$.

From this, we deduce a map $\Mor{A_g}{A_f}$ induced by universal property from. The universal
property ensures that this restriction map satisfies the functoriality conditions. It remains to
show that $\StructSh$ satisfies the restriction and gluing properties.

In order to prove this, we will first restrict to the case where the open set is $D(1)$, the
entirety of $\Spec(A)$, and the cover is comprised entirely of basis sets.
\begin{theorem}
  \label{thm:basis-restrict}
  Suppose $(D(f_i))_{i \in I}$ covers $\Spec(A)$, and $a, b \in \StructSh(\Spec(A))$, such that
  $\Res{a}{D(f_i)} = \Res{b}{D(f_i)}$, then $a = b$.
\end{theorem}
\begin{proof}
  We will first execute the standard maneuver of realizing $a = b$ if and only if $a - b = 0$, so we
  reduce to the case where $b = 0$. Next, if $\cup_i D(f_i) = D(1) = \Spec(A)$ then
  $\cap_i V(f_i) = \emptyset$. Unfolding definitions shows $\cap_i V(f_i) = V((f_i)_{i \in
    I})$. Moreover, if for some ideal $I$, $V(I) = \emptyset$, then $I$ must contain $1$ as every
  non-proper ideal is contained in a maximal ideal. Therefore, $1 \in (f_i)_{i \in I}$ and so there
  is a finite subset $J \subseteq I$ such that $1 = \sum_j a_jf_j$.

  Now, suppose that $\Res{a}{D(f_j)} = 0$ for all $j \in J$, then $f_j^m a = 0$. Since $J$ is
  finite, we may pick $m$ large enough that $f_j^m a = 0$ for all $m$. Therefore,
  $(\sum_j a_jf_j)^{m'} a = 0$ for $m' = \verts{J} m$, but $\sum_j a_jf_j = 1$, so $a = 0$ as
  required.
\end{proof}

Next, we must show that we can glue elements together.
\begin{theorem}
  \label{thm:basis-glue}
  Suppose $(D(f_i))_{i \in I}$ covers $\Spec(A)$ and there is a family $a_i \in \StructSh(D(f_i))$
  such that $\Res{a_i}{D(f_if_j)} = \Res{a_j}{D(f_if_j)}$, there exists an
  $a \in \StructSh(\Spec(A))$ such that $\Res{a}{D(f_i)} = a_i$.
\end{theorem}
\begin{proof}
  By the argument in \cref{thm:basis-restrict}, we restrict our attention to some finite subset of
  $I$ which still covers $\Spec A$.

  First, we observe that $a_i = \frac{b_i}{f_i^{n_i}}$ by the definition of $\StructSh$ with
  $b_i \in A$. Moreover, since these agree on the overlap, we must have the following equations:
  \begin{equation}
    \label{eq:overlap-condition-1}
    (f_if_j)^{m_{i,j}}(b_if_j^{n_j} - b_jf_i^{n_i}) = 0
  \end{equation}
  We pick an $m$ such that $m > m_{i,j}$. We also set $c_i = b_if_i^{(n_i + 1)m}$ and
  $g_i = f_i^{(n_i + 1)m + n_i}$. We observe that $c_i/g_i = b_i/f_i^{n_i}$, but we may now simplify
  \cref{eq:overlap-condition-1} to the following:
  \begin{equation}
    \label{eq:overlap-condition-2}
    c_ig_j = c_jg_i
  \end{equation}
  Calculating more explicitly,
  \begin{align*}
    c_ig_j
    &= b_if_i^{(n_i + 1)m}f_j^{n_j + m(n_j + 1)}\\
    &= b_if_j^{n_j} (f_if_j)^{m}(f_i^{n_i}f_j^{n_j})^m\\
    &= b_jf_i^{n_i} (f_if_j)^{m}(f_i^{n_i}f_j^{n_j})^m && \text{\cref{eq:overlap-condition-1}}\\
    &= b_jf_i^{n_i + m(n_i + 1)}f_j^{m(n_j + 1)}\\
    &= c_j g_i
  \end{align*}
  Next, notice that $(D(g_i))_{i \in I}$ still covers $\Spec A$, so there must be some family
  $(r_i)_{i \in I}$ satisfying the following property:
  \begin{equation}
    \label{eq:gs-cover}
    \sum_i r_ig_i = 1
  \end{equation}

  We now choose $a = \sum_i r_ic_i$. This is clearly an element of $A = \StructSh(\Spec(A))$, but
  remains to show that it restricts correctly. Observe the following:
  \begin{align*}
    g_j \sum_i r_ic_i
    &= \sum_i r_i c_ig_j\\
    &= \sum_i r_i g_i c_j && \text{\cref{eq:overlap-condition-2}}\\
    &= (\sum_i r_i g_i) c_j\\
    &= b_j && \text{\cref{eq:gs-cover}}
  \end{align*}
  Therefore, $a = \frac{c_j}{g_j} = a_j$ as required.
\end{proof}

Next, we show that we can generalize these arguments to allow for a basic open in place of $\Spec
A$.
\begin{theorem}
  \label{thm:basis-sheaf}
  $\StructSh$ satisfies the restriction and gluing axioms for any $D(f)$.
\end{theorem}
\begin{proof}
  We observe that $\StructSh(D(f)) = A_f$ and replacing $A$ with $A_f$, these claims reduce
  precisely to \cref{thm:basis-restrict,thm:basis-glue}. This argument hinges on the observation
  that $D(g/f^n) = D(g)$ as basic opens of $\Spec(A_f)$, as $\frac{1}{f}$ is a unit on this ring.
\end{proof}

At this point, we have constructed a sheaf over the collection of basic opens of $\Spec(A)$, but it
remains to extend this sheaf to arbitrary open sets. This is essentially an instance of
sheafification, but we spell it out in excruciating detail for the sake of education.

First, we require the notion of a stalk. We define $\StructSh_p$ for $p \in \Spec(A)$ which shall
intuitively represent a section of $\StructSh$ for an infinitesimal neighborhood of $p$. More
precisely,
\begin{equation}
  \label{eq:stalk}
  \StructSh_p = \Colim_{B \ni p} \StructSh(B)
\end{equation}
Here we have written $B$ for an arbitrary basic open set. Note that $\StructSh_p$ inherits the ring
structure of $\StructSh_p$. We write the inclusion of $f \in \StructSh(B)$ into $\StructSh_p$ as
$f_p$.

We now are now in a position to reap the main reward of our prior theorems:
\begin{theorem}
  \label{thm:stalk-restrict}
  There is a canonical isomorphism:
  \[
    \StructSh(B) \cong
    F(B) =
    \braces{
      x : \textstyle\prod_{p \in B} \StructSh_p \mathrel{\delimsep{|}}
      \forall p.\ \exists V \ni p, s \in \StructSh(V).\ \forall q \in V.\ x(q) = s_q
    }
  \]
  In other words, a locally constant collection of functions on $B$ precisely determines a function
  on all of $B$.
\end{theorem}
\begin{proof}
  There is a canonical map $\Mor{\StructSh(U)}{F(B)}$, given by sending $x$ to the constant
  function $p \mapsto x$. It remains to show that this is injective and surjective.

  Suppose that we are given $x$, $y$ and that $p \mapsto x = p \mapsto y$ in $F(B)$. Then, for each
  $p$ we must have some $B_i \ni p$ such that $\Res{x}{B_i} = \Res{y}{B_i}$. However, as this
  collection then covers $B$, \cref{thm:basis-restrict} implies $x = y$ as required.

  Next, suppose that we have some $z \in F(B)$, then for any $p \in B$ we must have some $V_i \ni p$
  and $s_i \in \StructSh(V_i)$ such that $z(q) = s$ for all $q \in V_i$.

  It suffices to show that $(s_i)_{i \in I}$ enjoys the precondition of \cref{thm:basis-glue}, that
  is, $\Res{s_i}{V_i \cap V_j} = \Res{s_i}{V_i \cap V_j}$. We observe that for each
  $p \in V_i \cap V_j$, that $z(p) = (s_i)_p = (s_j)_p$ by definition of $V_i$ and $V_j$. Therefore,
  there is a basic open $V_{i,j,p} \subseteq V_i \cap V_j$ around each $p \in V_i \cap V_j$ such
  that $\Res{s_i}{V_{i,j,p}} = \Res{s_j}{V_{i,j,p}}$. Clearly the family of $V_{i,j,p}$ covers
  $V_i \cap V_j$, so \cref{thm:basis-restrict} implies
  $\Res{s_i}{V_i \cap V_j} = \Res{s_j}{V_i \cap V_j}$ as required.
\end{proof}

\begin{theorem}
  The sheaf on basic opens $\StructSh$ extends uniquely to any open of $\Spec(A)$.
\end{theorem}
\begin{proof}
  We define the extension of $\StructSh$ to an arbitrary open set $U$:
  \[
    F(U) = \braces{
      x : \textstyle\prod_{p \in U} \StructSh_p \mathrel{\delimsep{|}}
      \forall p.\ \exists B \ni p, s \in \StructSh(B).\ \forall q \in B.\ x(q) = s_q
    }
  \]
  We have already shown in \cref{thm:stalk-restrict} that $F(B) \cong \StructSh(B)$. It remains to
  show that it is a sheaf. However, this follows immediately through the standard gluing and
  restriction operations one performs on functions.

  In fact, as $\StructSh$ is defined on a basis, $F$ is unique with this property. For any sheaf we
  must have $G(U) = \Lim_{B \subseteq U} G(B)$, so there is at most one extension of $\StructSh$.
\end{proof}

\printbibliography

\end{document}
